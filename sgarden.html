<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 9</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 0 },
                debug: true
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

	var levels;
	var level = 0;
	var round = 0;
    	var score = 0;
	var strings;
	var regex;
	var mistake;

	var regexText;
	var mistakeText;
    	var levelText;
    	var roundText;
    	var scoreText;
	var fruits;
    	var player;
    	var cursors;
	var weedKey;

	var freeFruits = [];

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.json('levels', 'assets/sglevels.json');
        this.load.spritesheet('dude', 'assets/dude.png', { frameWidth: 32, frameHeight: 48 });
    }

    function create ()
    {

	weedKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.Z);

	eating = false;
	weeding = false;

        player = this.physics.add.sprite(100, 450, 'dude');

        player.setBounce(0.2);
        player.setCollideWorldBounds(true);

        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'turn',
            frames: [ { key: 'dude', frame: 4 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
            frameRate: 10,
            repeat: -1
        });

        cursors = this.input.keyboard.createCursorKeys();

	levels = this.cache.json.get('levels');

	regex = levels[level].rounds[round].regex;

	strings = levels[level].rounds[round].strings;

	n = strings.length;

	step = (800-16*2) / n;

	scene = this;

	i = 0;

	fruits = strings.map(function (child) {

		fruit = scene.add.text(16+i*step, 92 + Phaser.Math.Between(0,600-92-32), child[0]+child[1], { fontSize:'16px', fill: '#FFF' });

		fruit.index = i;

		i = i + 1;

		return fruit;	

        });

	fruits.forEach(function(each) {

		scene.physics.world.enable(each);
		each.body.immovable = true;
	});

	this.physics.add.overlap(player, fruits, eatFruit, null, this);


        levelText = this.add.text(16, 16, 'level: ' + (level+1), { fontSize: '16px', fill: '#FFF' });

        roundText = this.add.text(128, 16, 'round: ' + (round+1), { fontSize: '16px', fill: '#FFF' });

        scoreText = this.add.text(232, 16, 'score: 0', { fontSize: '16px', fill: '#FFF' });

	regexText = this.add.text(128,64, 'regex: ' + regex, { fontSize:'32px', fill:'#FFF' });

	mistakeText = this.add.text(360,64, '', { fontSize:'32px', fill:'#FFF' });


	this.time.addEvent({delay:3000, callback: onTimeout, callbackScope: this,loop: true});
    }


	function onTimeout() {

		if (freeFruits.length == 0) return;

		fruit = freeFruits.pop();

		x = fruit.x;

		fruit.y = 92 + Phaser.Math.Between(0,600-92-32);
		fruit.x = x;

		i = Phaser.Math.Between(0, strings.length-1);

		scene.physics.world.remove(fruit.body);

		fruit.body = null;

		fruit.setText(strings[i][0] + strings[i][1]);

		scene.physics.world.enable(fruit);

		fruit.index = i;
		fruit.body.enable=true;
		fruit.body.gameObject.visible = true;


	}

	function toxic(fruit) {
	
		return strings[fruit.index][1].length > 0;

	}

    function update ()
    {
        if (cursors.left.isDown)
        {
            player.setVelocityX(-160);

            player.anims.play('left', true);
        }
        else if (cursors.right.isDown)
        {
            player.setVelocityX(160);

            player.anims.play('right', true);
        }
        else if (cursors.down.isDown)
        {
            player.setVelocityY(160);

            player.anims.play('turn');
        }
        else if (cursors.up.isDown)
        {
            player.setVelocityY(-160);
            player.anims.play('turn');
	}
        else 
        {
            player.setVelocityX(0);
            player.setVelocityY(0);

            player.anims.play('turn');
        }

	if (cursors.space.isDown) {
		eating = true;
	}
	else {
		eating = false;
	}

	if (weedKey.isDown) {

		weeding = true;
	}
	else {
		weeding = false;
	}
		
    }

	function eatFruit(player, fruit) {

		if (!eating && !weeding) return;

		if (fruit.body.enable == false) return;

		if (eating) {

			if (toxic(fruit)) {
				score = score - 1;
				mistakeText.setText('mismatch: ' + strings[fruit.index][0] + '>' + strings[fruit.index][1] + '<');
			} else {
				score = score + 1;
				mistakeText.setText('');
			}
		}

		if (weeding) {

			if (toxic(fruit)) {
				score = score + 1;
				mistakeText.setText('');
			}
			else {
				score = score + 1;
				mistakeText.setText('match: ' + strings[fruit.index][0]);
			}
		}

		scoreText.setText('score: ' + score); 

		fruit.body.enable=false;
		fruit.body.gameObject.visible = false;
		freeFruits.push(fruit);
	}

</script>

</body>
</html>
